<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>nestjs-starter documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css" media="(prefers-color-scheme: dark)">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">nestjs-starter documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content injectable">
                   <div class="content-data">







<ol class="breadcrumb">
  <li>Injectables</li>
  <li >PrismaService</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/common/helper/services/prisma.service.ts</code>
        </p>


            <p class="comment">
                <h3>Description</h3>
            </p>
            <p class="comment">
                <p>PrismaService</p>
<p><code>PrismaService</code> is a service that extends the PrismaClient class to manage database operations with Prisma ORM. It handles
initialization and teardown of database connections, executes raw queries with parameter escaping, supports transactions,
and provides a health check for the database connection.</p>

            </p>

            <p class="comment">
                <h3>Extends</h3>
            </p>
            <p class="comment">
                    <code>PrismaClient</code>
            </p>


            <section>
    <h3 id="index">Index</h3>
    <table class="table table-sm table-bordered index-table">
        <tbody>

                <tr>
                    <td class="col-md-4">
                        <h6><b>Methods</b></h6>
                    </td>
                </tr>
                <tr>
                    <td class="col-md-4">
                        <ul class="index-list">
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#executeRawQuery" >executeRawQuery</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#executeTransaction" >executeTransaction</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#isHealthy" >isHealthy</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#onModuleDestroy" >onModuleDestroy</a>
                            </li>
                            <li>
                                    <span class="modifier">Async</span>
                                <a href="#onModuleInit" >onModuleInit</a>
                            </li>
                        </ul>
                    </td>
                </tr>





        </tbody>
    </table>
</section>

            <section>
    <h3 id="constructor">Constructor</h3>
        <table class="table table-sm table-bordered">
            <tbody>
                <tr>
                    <td class="col-md-4">
<code>constructor(configService: <a href="../classes/ConfigService.html" target="_self">ConfigService&lt;AllConfigType&gt;</a>)</code>
                    </td>
                </tr>
                        <tr>
                            <td class="col-md-4">
                                <div class="io-line">Defined in <a href="" data-line="28" class="link-to-prism">src/common/helper/services/prisma.service.ts:28</a></div>
                            </td>
                        </tr>

                <tr>
                    <td class="col-md-4">
                            <div class="io-description"><p>Creates an instance of PrismaService.</p>
</div>
                            <div>
                                    <b>Parameters :</b>
                                    <table class="params">
                                        <thead>
                                            <tr>
                                                <td>Name</td>
                                                    <td>Type</td>
                                                <td>Optional</td>
                                                    <td>Description</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                                <tr>
                                                        <td>configService</td>
                                                  
                                                        <td>
                                                                        <code><a href="../classes/ConfigService.html" target="_self" >ConfigService&lt;AllConfigType&gt;</a></code>
                                                        </td>
                                                  
                                                    <td>
                                                            No
                                                    </td>
                                                    
                                                        <td>
                                                                <code><ul>
<li>The configuration service for retrieving database connection details.</li>
</ul>
</code>
                                                        </td>
                                                </tr>
                                        </tbody>
                                    </table>
                            </div>
                    </td>
                </tr>
            </tbody>
        </table>
</section>

            <section>
    
    <h3 id="methods">
        Methods
    </h3>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="executeRawQuery"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>executeRawQuery</b></span>
                        <a href="#executeRawQuery"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>executeRawQuery(queryObj: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>, data: <a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank">any</a>, fields: string[])</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="79"
                            class="link-to-prism">src/common/helper/services/prisma.service.ts:79</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>Executes a raw query with optional data and field sanitization.</p>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                    <td>Default value</td>
                                    <td>Description</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>queryObj</td>
                                    <td>
                                                <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>

                                    <td>
                                        <code>null</code>
                                    </td>

                                    <td>
                                        <ul>
<li>The query object with a <code>syntax</code> method to generate the query string.</li>
</ul>

                                    </td>
                                </tr>
                                <tr>
                                    <td>data</td>
                                    <td>
                                                <code><a href="https://www.typescriptlang.org/docs/handbook/basic-types.html" target="_blank" >any</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>

                                    <td>
                                        <code>null</code>
                                    </td>

                                    <td>
                                        <ul>
<li>Optional data to be used in the query.</li>
</ul>

                                    </td>
                                </tr>
                                <tr>
                                    <td>fields</td>
                                    <td>
                                            <code>string[]</code>
                                    </td>

                                    <td>
                                        No
                                    </td>

                                    <td>
                                        <code>[]</code>
                                    </td>

                                    <td>
                                        <ul>
<li>Optional fields to be sanitized in the data.</li>
</ul>

                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;any&gt;</code>

                    </div>
                    <div class="io-description">
                        <ul>
<li>The result of the query.</li>
</ul>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="executeTransaction"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>executeTransaction</b></span>
                        <a href="#executeTransaction"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>executeTransaction(actions: (prisma: Prisma.TransactionClient) => void)</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="129"
                            class="link-to-prism">src/common/helper/services/prisma.service.ts:129</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>Executes a transaction with Prisma.</p>
</div>

                    <div class="io-description">
                        <b>Parameters :</b>
                        <table class="params">
                            <thead>
                                <tr>
                                    <td>Name</td>
                                    <td>Type</td>
                                    <td>Optional</td>
                                    <td>Description</td>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>actions</td>
                                    <td>
                                                <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/function" target="_blank" >function</a></code>
                                    </td>

                                    <td>
                                        No
                                    </td>


                                    <td>
                                        <ul>
<li>A function containing the transactional operations.</li>
</ul>

                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;any&gt;</code>

                    </div>
                    <div class="io-description">
                        <ul>
<li>The result of the transaction.</li>
</ul>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="isHealthy"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>isHealthy</b></span>
                        <a href="#isHealthy"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>isHealthy()</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="141"
                            class="link-to-prism">src/common/helper/services/prisma.service.ts:141</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>Checks the health of the Prisma connection by executing a simple query.</p>
</div>

                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;HealthIndicatorResult&gt;</code>

                    </div>
                    <div class="io-description">
                        <ul>
<li>The result of the health check.</li>
</ul>

                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="onModuleDestroy"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>onModuleDestroy</b></span>
                        <a href="#onModuleDestroy"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>onModuleDestroy()</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="61"
                            class="link-to-prism">src/common/helper/services/prisma.service.ts:61</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>Called when the module is destroyed. Disconnects from the database.</p>
</div>

                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="table table-sm table-bordered">
        <tbody>
            <tr>
                <td class="col-md-4">
                    <a name="onModuleInit"></a>
                    <span class="name">
                        <span class="modifier">Async</span>
                        <span ><b>onModuleInit</b></span>
                        <a href="#onModuleInit"><span class="icon ion-ios-link"></span></a>
                    </span>
                </td>
            </tr>
            <tr>
                <td class="col-md-4">
                    <span class="modifier-icon icon ion-ios-reset"></span>
                    <code>onModuleInit()</code>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-line">Defined in <a href="" data-line="51"
                            class="link-to-prism">src/common/helper/services/prisma.service.ts:51</a></div>
                </td>
            </tr>


            <tr>
                <td class="col-md-4">
                    <div class="io-description"><p>Called when the module is initialized. Connects to the database.</p>
</div>

                    <div>
                    </div>
                    <div class="io-description">
                        <b>Returns : </b>    <code>Promise&lt;void&gt;</code>

                    </div>
                    <div class="io-description">
                        
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</section>

    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable, OnModuleInit, OnModuleDestroy } from &#x27;@nestjs/common&#x27;;
import { ConfigService } from &#x27;@nestjs/config&#x27;;
import { HealthIndicatorResult } from &#x27;@nestjs/terminus&#x27;;

import { Prisma, PrismaClient } from &#x27;@prisma/client&#x27;;
import * as _ from &#x27;lodash&#x27;;

import { AllConfigType } from &#x27;@config/type/config.type&#x27;;

// import { ConfigService } from &#x27;../services/config.service&#x27;;

/**
 * PrismaService
 *
 * @description
 * &#x60;PrismaService&#x60; is a service that extends the PrismaClient class to manage database operations with Prisma ORM. It handles
 * initialization and teardown of database connections, executes raw queries with parameter escaping, supports transactions,
 * and provides a health check for the database connection.
 *
 * @export
 * @class PrismaService
 * @extends PrismaClient
 * @implements {OnModuleInit}
 * @implements {OnModuleDestroy}
 */

@Injectable()
export class PrismaService extends PrismaClient implements OnModuleInit, OnModuleDestroy {
    /**
     * Creates an instance of PrismaService.
     *
     * @param {ConfigService&lt;AllConfigType&gt;} configService - The configuration service for retrieving database connection details.
     */

    constructor(private readonly configService: ConfigService&lt;AllConfigType&gt;) {
        super({
            datasources: {
                db: {
                    url: configService.get(&#x27;database.url&#x27;, { infer: true }), // configService.prismaConfig,
                },
            },
        });
    }

    /**
     * Called when the module is initialized. Connects to the database.
     *
     * @returns {Promise&lt;void&gt;}
     */

    async onModuleInit(): Promise&lt;void&gt; {
        await this.$connect();
    }

    /**
     * Called when the module is destroyed. Disconnects from the database.
     *
     * @returns {Promise&lt;void&gt;}
     */

    async onModuleDestroy(): Promise&lt;void&gt; {
        await this.$disconnect();
    }

    // async executeRawQuery(query: string, params?: any[]): Promise&lt;any&gt; {
    //     return this.$queryRawUnsafe(query, ...params);
    // }

    /**
     * Executes a raw query with optional data and field sanitization.
     *
     * @param {any} queryObj - The query object with a &#x60;syntax&#x60; method to generate the query string.
     * @param {any} [data&#x3D;null] - Optional data to be used in the query.
     * @param {string[]} [fields&#x3D;[]] - Optional fields to be sanitized in the data.
     *
     * @returns {Promise&lt;any&gt;} - The result of the query.
     */

    async executeRawQuery(
        queryObj: any &#x3D; null,
        data: any &#x3D; null,
        fields: string[] &#x3D; []
    ): Promise&lt;any&gt; {
        const newObj &#x3D; Object.assign({}, data);

        if (typeof data &#x3D;&#x3D; &#x27;object&#x27; &amp;&amp; data instanceof Object &amp;&amp; !(data instanceof Array)) {
            for (const [key, value] of Object.entries(newObj)) {
                const found &#x3D; fields.includes(key);
                if (found) {
                    const escValue &#x3D; value as any;
                    // newObj[key] &#x3D; escValue.replace(/&#x27;/g, &quot;\\&#x27;&quot;);
                    newObj[key] &#x3D; escValue.replace(/&#x27;/g, &quot;&#x27;&#x27;&quot;);
                }
            }
        }

        let query: string;
        if (data) {
            query &#x3D; queryObj.syntax(
                typeof data &#x3D;&#x3D; &#x27;object&#x27; &amp;&amp; data instanceof Object &amp;&amp; !(data instanceof Array)
                    ? newObj
                    : data
            );
        } else {
            query &#x3D; queryObj.syntax();
        }

        // return this.$queryRawUnsafe(query, ...params);
        const rows &#x3D; await this.$queryRawUnsafe(query);

        let result: any;
        if (queryObj.type &#x3D;&#x3D; &#x27;SELECT_ONE&#x27; || queryObj.type &#x3D;&#x3D; &#x27;INSERT&#x27;) {
            result &#x3D; !_.isEmpty(rows) ? rows[0] : null; //do not change null to blank object
        } else {
            result &#x3D; rows;
        }

        return result;
    }

    /**
     * Executes a transaction with Prisma.
     *
     * @param {(prisma: Prisma.TransactionClient) &#x3D;&gt; Promise&lt;any&gt;} actions - A function containing the transactional operations.
     *
     * @returns {Promise&lt;any&gt;} - The result of the transaction.
     */

    async executeTransaction(
        actions: (prisma: Prisma.TransactionClient) &#x3D;&gt; Promise&lt;any&gt;
    ): Promise&lt;any&gt; {
        return this.$transaction(actions);
    }

    /**
     * Checks the health of the Prisma connection by executing a simple query.
     *
     * @returns {Promise&lt;HealthIndicatorResult&gt;} - The result of the health check.
     */

    async isHealthy(): Promise&lt;HealthIndicatorResult&gt; {
        try {
            await this.$queryRaw&#x60;SELECT 1&#x60;;
            // console.log(&#x27;RESULTTTTTTTTTTTTTTTTTTTT&#x27;, x);
            return Promise.resolve({
                prisma: {
                    status: &#x27;up&#x27;,
                },
            });
        } catch (e) {
            return Promise.resolve({
                prisma: {
                    status: &#x27;down&#x27;,
                },
            });
            console.log(e);
        }
    }
}
</code></pre>
    </div>

</div>







                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'injectable';
            var COMPODOC_CURRENT_PAGE_URL = 'PrismaService.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       
       <script type="module" src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
